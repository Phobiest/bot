import asyncio
import random
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.client.default import DefaultBotProperties

TOKEN = "7989061206:AAEHzYzKjoDdUzL3wkry-CclObKinqZeE3o"

# –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
bot = Bot(
    token=TOKEN,
    default=DefaultBotProperties(parse_mode="HTML")
)
dp = Dispatcher()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
user_data = {}

# –°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥
REWARDS = {
    50: "–¢–∞–ª–∏—Å–º–∞–Ω '–ú–µ–¥–æ–≤—ã–µ —Å–æ—Ç—ã'",
    100: "–¢–∞–ª–∏—Å–º–∞–Ω '–õ–∞–ø–∫–∞ –∫—Ä–æ–ª–∏–∫–∞'", 
    150: "–¢–∞–ª–∏—Å–º–∞–Ω '–ß–µ—Ä–µ–ø–∞—à—å—è –º–æ—â—å'", 
    200: "100 –≤–∞–ª—é—Ç—ã",
    450: "1000 –≤–∞–ª—é—Ç—ã",
    1000: "–ë—Ä–æ–Ω—è Type B",
    2000: "–ë—Ä–æ–Ω—è Type A",
    2500: "–®–∞–ª–∫–µ—Ä –∑–µ–ª–∏–π",
    4000: "–ë—Ä–æ–Ω—è Type X",
    6000: "–ë—Ä–æ–Ω—è Type Y",
    10000: "–†–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ø–µ—Ü –æ—Ä—É–∂–∏–µ"
}

@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    user_id = message.from_user.id
    if user_id not in user_data:
        user_data[user_id] = {"balance": 0, "last_daily": None}
    
    await message.answer(
        "üåü <b>Nexus Space Bot</b>\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/daily - –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞\n"
        "/balance - –ë–∞–ª–∞–Ω—Å\n" 
        "/rewards - –°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥\n"
        "/top - –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤"
    )

@dp.message(Command("daily"))
async def daily_cmd(message: types.Message):
    user_id = message.from_user.id
    today = datetime.now().date()
    
    if user_id not in user_data:
        user_data[user_id] = {"balance": 0, "last_daily": None}
    
    last_daily = user_data[user_id]["last_daily"]
    
    if last_daily and last_daily == today:
        await message.answer("‚ùå –£–∂–µ –ø–æ–ª—É—á–∞–ª –Ω–∞–≥—Ä–∞–¥—É —Å–µ–≥–æ–¥–Ω—è!")
        return
    
    points = random.randint(1, 150)
    user_data[user_id]["balance"] += points
    user_data[user_id]["last_daily"] = today
    
    await message.answer(
        f"üéâ +{points} ‚≠ê\n"
        f"–ë–∞–ª–∞–Ω—Å: {user_data[user_id]['balance']} ‚≠ê\n"
        f"–ù–∞–≥—Ä–∞–¥—ã: /rewards"
    )

@dp.message(Command("balance"))
async def balance_cmd(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data:
        user_data[user_id] = {"balance": 0, "last_daily": None}
    
    balance = user_data[user_id]["balance"]
    await message.answer(f"üí∞ –ë–∞–ª–∞–Ω—Å: {balance} ‚≠ê")

@dp.message(Command("rewards"))
async def rewards_cmd(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data:
        user_data[user_id] = {"balance": 0, "last_daily": None}
    
    balance = user_data[user_id]["balance"]
    
    text = f"üéÅ –ù–∞–≥—Ä–∞–¥—ã (–í–∞—à –±–∞–ª–∞–Ω—Å: {balance} ‚≠ê)\n\n"
    
    for cost, reward in REWARDS.items():
        if balance >= cost:
            text += f"‚úÖ {cost} ‚≠ê - {reward}\n"
        else:
            text += f"‚ùå {cost} ‚≠ê - {reward}\n"
    
    text += "\nüíé –û–±—Ä–∞—Ç–∏—Å—å –∫ –∞–¥–º–∏–Ω—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è"
    await message.answer(text)

@dp.message(Command("top"))
async def top_cmd(message: types.Message):
    if not user_data:
        await message.answer("üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
        return
    
    top_users = sorted(user_data.items(), key=lambda x: x[1]["balance"], reverse=True)[:5]
    
    text = "üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤:\n\n"
    
    for i, (user_id, data) in enumerate(top_users, 1):
        try:
            user = await bot.get_chat(user_id)
            name = user.first_name or f"–ò–≥—Ä–æ–∫ {user_id}"
        except:
            name = f"–ò–≥—Ä–æ–∫ {user_id}"
        
        balance = data["balance"]
        text += f"{i}. {name} - {balance} ‚≠ê\n"
    
    await message.answer(text)

async def main():
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        print("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...")
        await asyncio.sleep(10)
        await main()

if __name__ == "__main__":
    asyncio.run(main())
