import asyncio
import random
import json
import os
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.client.default import DefaultBotProperties

TOKEN = "7989061206:AAEHzYzKjoDdUzL3wkry-CclObKinqZeE3o"

# –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
bot = Bot(
    token=TOKEN,
    default=DefaultBotProperties(parse_mode="HTML")
)
dp = Dispatcher()

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = "user_data.json"

# –ö–∞–Ω–∞–ª—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
REQUIRED_CHANNELS = [
    {"id": "@Gogoida52", "name": "–ù–æ–≤–æ—Å—Ç–∏", "url": "https://t.me/Gogoida52"},
    {"id": "@goidagoidagoidagoida", "name": "–û–±—Å—É–∂–¥–µ–Ω–∏–µ", "url": "https://t.me/goidagoidagoidagoida"}
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
REFERRAL_BONUS = 100  # –ë–∞–ª–ª–æ–≤ –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞
REFERRER_BONUS = 50   # –ë–∞–ª–ª–æ–≤ —Ç–æ–º—É, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
def load_user_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ int (–ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ JSON –∫–ª—é—á–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å—Ç—Ä–æ–∫–∞–º–∏)
                converted_data = {}
                for k, v in data.items():
                    converted_data[int(k)] = v
                    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                    if 'referrals' not in v:
                        v['referrals'] = []
                    if 'referrer' not in v:
                        v['referrer'] = None
                return converted_data
        except (json.JSONDecodeError, KeyError, ValueError):
            return {}
    return {}

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª
def save_user_data():
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(user_data, f, ensure_ascii=False, indent=2)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
user_data = load_user_data()

# ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π)
ADMIN_ID = 6236189739  # ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® ID

# –°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥
REWARDS = {
    50: "–¢–∞–ª–∏—Å–º–∞–Ω '–ú–µ–¥–æ–≤—ã–µ —Å–æ—Ç—ã'",
    100: "–¢–∞–ª–∏—Å–º–∞–Ω '–õ–∞–ø–∫–∞ –∫—Ä–æ–ª–∏–∫–∞'", 
    150: "–¢–∞–ª–∏—Å–º–∞–Ω '–ß–µ—Ä–µ–ø–∞—à—å—è –º–æ—â—å'", 
    200: "100 –≤–∞–ª—é—Ç—ã",
    450: "1000 –≤–∞–ª—é—Ç—ã",
    1000: "–ë—Ä–æ–Ω—è Type B",
    2000: "–ë—Ä–æ–Ω—è Type A",
    2500: "–®–∞–ª–∫–µ—Ä –∑–µ–ª–∏–π",
    4000: "–ë—Ä–æ–Ω—è Type X",
    6000: "–ë—Ä–æ–Ω—è Type Y",
    10000: "–†–∞–Ω–¥–æ–º–Ω–æ–µ —Å–ø–µ—Ü –æ—Ä—É–∂–∏–µ"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
async def check_subscription(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã"""
    for channel in REQUIRED_CHANNELS:
        try:
            member = await bot.get_chat_member(chat_id=channel["id"], user_id=user_id)
            if member.status in ['left', 'kicked']:
                return False
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ {channel['name']}: {e}")
            return False
    return True

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏
def get_subscription_keyboard():
    keyboard = types.InlineKeyboardMarkup(inline_keyboard=[])
    for channel in REQUIRED_CHANNELS:
        keyboard.inline_keyboard.append([
            types.InlineKeyboardButton(text=f"üì¢ {channel['name']}", url=channel["url"])
        ])
    keyboard.inline_keyboard.append([
        types.InlineKeyboardButton(text="‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_subscription")
    ])
    return keyboard

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
@dp.callback_query(lambda c: c.data == "check_subscription")
async def check_subscription_callback(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    
    if await check_subscription(user_id):
        if user_id not in user_data:
            user_data[user_id] = {
                "balance": 0, 
                "last_daily": None,
                "referrals": [],
                "referrer": None
            }
            save_user_data()
        
        await callback.message.edit_text(
            "üéâ <b>–û—Ç–ª–∏—á–Ω–æ! –¢—ã –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã!</b>\n\n"
            "üåü <b>Nexus Space Bot</b>\n\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "/daily - –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞\n"
            "/balance - –ë–∞–ª–∞–Ω—Å\n" 
            "/rewards - –°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥\n"
            "/top - –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤\n"
            "/referral - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞\n\n"
            "üõí <b>–î–ª—è –ø–æ–∫—É–ø–∫–∏:</b> –Ω–∞–ø–∏—à–∏ '–∫—É–ø–ª—é [–Ω–æ–º–µ—Ä]'"
        )
    else:
        await callback.answer("‚ùå –¢—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã!", show_alert=True)

@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    user_id = message.from_user.id
    args = message.text.split()
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
    referrer_id = None
    if len(args) > 1 and args[1].startswith('ref'):
        try:
            referrer_id = int(args[1][3:])  # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ ref123456
            if referrer_id == user_id:
                referrer_id = None  # –ù–µ–ª—å–∑—è –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è
        except ValueError:
            referrer_id = None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    if not await check_subscription(user_id):
        subscription_text = "üì¢ <b>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã:</b>\n\n"
        for channel in REQUIRED_CHANNELS:
            subscription_text += f"üîπ {channel['name']} - {channel['url']}\n"
        
        subscription_text += "\n–ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
        
        await message.answer(
            subscription_text,
            reply_markup=get_subscription_keyboard()
        )
        return
    
    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
    if user_id not in user_data:
        user_data[user_id] = {
            "balance": 0, 
            "last_daily": None,
            "referrals": [],
            "referrer": referrer_id
        }
        
        # –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å—ã –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
        if referrer_id and referrer_id in user_data:
            # –ë–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–º—É
            user_data[user_id]["balance"] += REFERRAL_BONUS
            
            # –ë–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É
            user_data[referrer_id]["balance"] += REFERRER_BONUS
            user_data[referrer_id]["referrals"].append(user_id)
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
            try:
                await bot.send_message(
                    referrer_id,
                    f"üéâ <b>–ü–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!</b>\n\n"
                    f"üí´ –¢—ã –ø–æ–ª—É—á–∏–ª: <b>+{REFERRER_BONUS} ‚≠ê</b>\n"
                    f"üë§ –¢–≤–æ–π –¥—Ä—É–≥ –ø–æ–ª—É—á–∏–ª: <b>+{REFERRAL_BONUS} ‚≠ê</b>\n"
                    f"üìä –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: <b>{len(user_data[referrer_id]['referrals'])}</b>"
                )
            except:
                pass  # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        
        save_user_data()
    
    welcome_text = (
        "üåü <b>Nexus Space Bot</b>\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/daily - –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞\n"
        "/balance - –ë–∞–ª–∞–Ω—Å\n" 
        "/rewards - –°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥\n"
        "/top - –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤\n"
        "/referral - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞\n\n"
        "üõí <b>–î–ª—è –ø–æ–∫—É–ø–∫–∏:</b> –Ω–∞–ø–∏—à–∏ '–∫—É–ø–ª—é [–Ω–æ–º–µ—Ä]'"
    )
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à–µ–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–Ω—É—Å
    if referrer_id and user_id in user_data and user_data[user_id]["balance"] >= REFERRAL_BONUS:
        welcome_text = f"üéÅ <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å: +{REFERRAL_BONUS} ‚≠ê</b>\n\n" + welcome_text
    
    await message.answer(welcome_text)

# –ö–æ–º–∞–Ω–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
@dp.message(Command("referral"))
async def referral_cmd(message: types.Message):
    user_id = message.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    if not await check_subscription(user_id):
        subscription_text = "‚ùå <b>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã:</b>\n\n"
        for channel in REQUIRED_CHANNELS:
            subscription_text += f"üîπ {channel['name']} - {channel['url']}\n"
        
        subscription_text += "\n–ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
        
        await message.answer(
            subscription_text,
            reply_markup=get_subscription_keyboard()
        )
        return
    
    if user_id not in user_data:
        user_data[user_id] = {
            "balance": 0, 
            "last_daily": None,
            "referrals": [],
            "referrer": None
        }
        save_user_data()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏
    bot_info = await bot.get_me()
    referral_link = f"https://t.me/{bot_info.username}?start=ref{user_id}"
    
    referral_count = len(user_data[user_id]["referrals"])
    total_earned = referral_count * REFERRER_BONUS
    
    text = (
        "üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</b>\n\n"
        f"üîó <b>–¢–≤–æ—è —Å—Å—ã–ª–∫–∞:</b>\n<code>{referral_link}</code>\n\n"
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        f"‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: <b>{referral_count}</b>\n"
        f"‚Ä¢ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤: <b>{total_earned} ‚≠ê</b>\n\n"
        f"üéÅ <b>–ë–æ–Ω—É—Å—ã:</b>\n"
        f"‚Ä¢ –î—Ä—É–≥ –ø–æ–ª—É—á–∞–µ—Ç: <b>+{REFERRAL_BONUS} ‚≠ê</b>\n"
        f"‚Ä¢ –¢—ã –ø–æ–ª—É—á–∞–µ—à—å: <b>+{REFERRER_BONUS} ‚≠ê</b> –∑–∞ –∫–∞–∂–¥–æ–≥–æ\n\n"
        f"üí´ <b>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</b>\n"
        f"1. –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É —Å–≤–æ—é —Å—Å—ã–ª–∫—É\n"
        f"2. –î—Ä—É–≥ –¥–æ–ª–∂–µ–Ω –Ω–∞–∂–∞—Ç—å –Ω–∞ —Å—Å—ã–ª–∫—É\n"
        f"3. –û–±–∞ –ø–æ–ª—É—á–∞–µ—Ç–µ –±–æ–Ω—É—Å—ã!"
    )
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æÂàÜ‰∫´ —Å—Å—ã–ª–∫–∏
    keyboard = types.InlineKeyboardMarkup(inline_keyboard=[
        [types.InlineKeyboardButton(text="üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π", url=f"https://t.me/share/url?url={referral_link}&text=–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è%20–∫%20Nexus%20Space%20Bot!%20üéÆ")]
    ])
    
    await message.answer(text, reply_markup=keyboard)

# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥
def subscription_required(func):
    async def wrapper(message: types.Message, *args, **kwargs):
        user_id = message.from_user.id
        
        if not await check_subscription(user_id):
            subscription_text = "‚ùå <b>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã:</b>\n\n"
            for channel in REQUIRED_CHANNELS:
                subscription_text += f"üîπ {channel['name']} - {channel['url']}\n"
            
            subscription_text += "\n–ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
            
            await message.answer(
                subscription_text,
                reply_markup=get_subscription_keyboard()
            )
            return
        
        return await func(message, *args, **kwargs)
    return wrapper

@dp.message(Command("daily"))
@subscription_required
async def daily_cmd(message: types.Message):
    user_id = message.from_user.id
    today = datetime.now().date()
    
    if user_id not in user_data:
        user_data[user_id] = {
            "balance": 0, 
            "last_daily": None,
            "referrals": [],
            "referrer": None
        }
    
    last_daily = user_data[user_id]["last_daily"]
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ datetime.date –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if last_daily and isinstance(last_daily, str):
        last_daily = datetime.fromisoformat(last_daily).date()
        user_data[user_id]["last_daily"] = last_daily
    
    if last_daily and last_daily == today:
        await message.answer("‚ùå –£–∂–µ –ø–æ–ª—É—á–∞–ª –Ω–∞–≥—Ä–∞–¥—É —Å–µ–≥–æ–¥–Ω—è!")
        return
    
    points = random.randint(1, 150)
    user_data[user_id]["balance"] += points
    user_data[user_id]["last_daily"] = today.isoformat()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    
    save_user_data()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    
    await message.answer(
        f"üéâ +{points} ‚≠ê\n"
        f"–ë–∞–ª–∞–Ω—Å: {user_data[user_id]['balance']} ‚≠ê\n"
        f"–ù–∞–≥—Ä–∞–¥—ã: /rewards"
    )

@dp.message(Command("balance"))
@subscription_required
async def balance_cmd(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data:
        user_data[user_id] = {
            "balance": 0, 
            "last_daily": None,
            "referrals": [],
            "referrer": None
        }
        save_user_data()
    
    balance = user_data[user_id]["balance"]
    referral_count = len(user_data[user_id]["referrals"])
    
    text = f"üí∞ –ë–∞–ª–∞–Ω—Å: {balance} ‚≠ê"
    if referral_count > 0:
        text += f"\nüë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π: {referral_count}"
    
    await message.answer(text)

@dp.message(Command("rewards"))
@subscription_required
async def rewards_cmd(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data:
        user_data[user_id] = {
            "balance": 0, 
            "last_daily": None,
            "referrals": [],
            "referrer": None
        }
        save_user_data()
    
    balance = user_data[user_id]["balance"]
    
    text = f"üéÅ –ù–∞–≥—Ä–∞–¥—ã (–í–∞—à –±–∞–ª–∞–Ω—Å: {balance} ‚≠ê)\n\n"
    
    for cost, reward in REWARDS.items():
        if balance >= cost:
            text += f"‚úÖ {cost} ‚≠ê - {reward}\n"
        else:
            text += f"‚ùå {cost} ‚≠ê - {reward}\n"
    
    text += "\nüõí <b>–î–ª—è –ø–æ–∫—É–ø–∫–∏:</b> –Ω–∞–ø–∏—à–∏ '–∫—É–ø–ª—é [—Ü–µ–Ω–∞]'\n"
    text += "üíé –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤—å –∞–¥–º–∏–Ω—É –Ω–æ–º–µ—Ä –ø–æ–∫—É–ø–∫–∏ –≤ –õ–°"
    await message.answer(text)

@dp.message(Command("top"))
@subscription_required
async def top_cmd(message: types.Message):
    if not user_data:
        await message.answer("üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
        return
    
    top_users = sorted(user_data.items(), key=lambda x: x[1]["balance"], reverse=True)[:5]
    
    text = "üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤:\n\n"
    
    for i, (user_id, data) in enumerate(top_users, 1):
        try:
            user = await bot.get_chat(user_id)
            name = user.first_name or f"–ò–≥—Ä–æ–∫ {user_id}"
        except:
            name = f"–ò–≥—Ä–æ–∫ {user_id}"
        
        balance = data["balance"]
        referrals_count = len(data.get("referrals", []))
        text += f"{i}. {name} - {balance} ‚≠ê"
        if referrals_count > 0:
            text += f" (üë• {referrals_count})"
        text += "\n"
    
    await message.answer(text)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫—É–ø–∫–∏
@dp.message(lambda message: message.text and message.text.lower().startswith('–∫—É–ø–ª—é'))
@subscription_required
async def buy_reward(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data:
        await message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ /start")
        return
    
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è "–∫—É–ø–ª—é 50"
        reward_num = int(message.text.split()[1])
    except (IndexError, ValueError):
        await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: <b>–∫—É–ø–ª—é [–Ω–æ–º–µ—Ä]</b>\n–ù–∞–ø—Ä–∏–º–µ—Ä: <code>–∫—É–ø–ª—é 5</code>")
        return
    
    if reward_num not in REWARDS:
        await message.answer("‚ùå –¢–∞–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–∞–≥—Ä–∞–¥—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!\n–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–º–µ—Ä–∞: /rewards")
        return
    
    cost = reward_num  # –°—Ç–æ–∏–º–æ—Å—Ç—å = –Ω–æ–º–µ—Ä—É –Ω–∞–≥—Ä–∞–¥—ã
    balance = user_data[user_id]["balance"]
    
    if balance < cost:
        await message.answer(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤!\n–ù—É–∂–Ω–æ: {cost} ‚≠ê\n–£ –≤–∞—Å: {balance} ‚≠ê")
        return
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–º–µ—Ä –ø–æ–∫—É–ø–∫–∏
    purchase_id = random.randint(1000, 9999)
    
    # –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
    user_data[user_id]["balance"] -= cost
    reward = REWARDS[reward_num]
    
    save_user_data()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    user_text = f"""
üéä <b>–ü–æ–∫—É–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!</b>

üì¶ <b>–ù–æ–º–µ—Ä –ø–æ–∫—É–ø–∫–∏:</b> <code>#{purchase_id}</code>
üéÅ <b>–¢–æ–≤–∞—Ä:</b> {reward}
üí∞ <b>–°–ø–∏—Å–∞–Ω–æ:</b> {cost} ‚≠ê
üí≥ <b>–û—Å—Ç–∞–ª–æ—Å—å:</b> {user_data[user_id]['balance']} ‚≠ê

üìû <b>–î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:</b>
1. –ó–∞—Å–∫—Ä–∏–Ω—å –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å –∫–æ–¥–æ–º: <code>#{purchase_id}</code>
2. –ù–∞–ø–∏—à–∏ –∞–¥–º–∏–Ω—É –≤ –õ–° —ç—Ç–æ—Ç –∫–æ–¥
3. –ü–æ–ª—É—á–∏ —Å–≤–æ–π —Ç–æ–≤–∞—Ä –≤ –∏–≥—Ä–µ!

‚ö° <i>–ê–¥–º–∏–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å —Ç–æ–±–æ–π –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</i>
    """
    
    await message.answer(user_text)
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É (–µ—Å–ª–∏ ADMIN_ID —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    if ADMIN_ID:
        try:
            user_info = await bot.get_chat(user_id)
            admin_text = f"""
üõí <b>–ù–û–í–ê–Ø –ü–û–ö–£–ü–ö–ê!</b>

üë§ <b>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</b> {user_info.first_name} (@{user_info.username or '–Ω–µ—Ç'})
üìû <b>ID:</b> <code>{user_id}</code>
üì¶ <b>–ù–æ–º–µ—Ä –ø–æ–∫—É–ø–∫–∏:</b> <code>#{purchase_id}</code>
üéÅ <b>–¢–æ–≤–∞—Ä:</b> {reward}
üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> {cost} ‚≠ê
üí≥ <b>–ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ:</b> {user_data[user_id]['balance']} ‚≠ê

‚ö° <i>–û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏ —Ç–æ–≤–∞—Ä–∞</i>
            """
            await bot.send_message(ADMIN_ID, admin_text)
        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞: {e}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
async def auto_save():
    while True:
        await asyncio.sleep(300)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        save_user_data()
        print("üíæ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")

async def main():
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print(f"üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è {len(user_data)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    asyncio.create_task(auto_save())
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
        save_user_data()
        print("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º")
        print("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...")
        await asyncio.sleep(10)
        await main()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
        save_user_data()
        print("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
